name: Starter CI

on:
  push:
    branches: [ master, develop, staging, uat ]
  pull_request:
    branches: [ master, develop, staging, uat ]

permissions:
  contents: write
  packages: write

env:
  NODE_VERSION: '20'
  PKG_PATH: 'package.json'
  CR_REGISTRY: ghcr.io
  RELEASE_TYPE: 'patch'  # default release type; can be overridden

jobs:
  # ---------- Build + Lint ----------
  build_app:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure npm for Azure Artifacts (using AZURE_ARTIFACT_PAT)
        env:
          AZURE_ARTIFACTS_PAT: ${{ secrets.AZURE_ARTIFACT_PAT }}
        run: |
          if [ -n "$AZURE_ARTIFACTS_PAT" ]; then
            echo "Configuring npm for Azure Artifacts into project .npmrc"
            {
              echo ""
              echo "//pkgs.dev.azure.com/cadai/:_authToken=${AZURE_ARTIFACTS_PAT}"
              echo "always-auth=true"
            } >> .npmrc

            echo "Final .npmrc:"
            cat .npmrc
          else
            echo "AZURE_ARTIFACT_PAT is empty, skipping Azure Artifacts config"
          fi

      - name: Install dependencies & lint
        run: |
          npm ci
          npm run lint

  # ---------- Release (bump version, CHANGELOG, tag) ----------
  release:
    runs-on: ubuntu-latest
    needs: build_app
    if: |
      github.event_name != 'pull_request' && 
      contains(fromJson('["develop"]'), github.ref_name) &&
      !startsWith(github.event.head_commit.message, 'chore(release): v')
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure npm for Azure Artifacts
        env:
          AZURE_ARTIFACTS_PAT: ${{ secrets.AZURE_ARTIFACT_PAT }}
        run: |
          if [ -n "$AZURE_ARTIFACTS_PAT" ]; then
            {
              echo ""
              echo "//pkgs.dev.azure.com/cadai/:_authToken=${AZURE_ARTIFACTS_PAT}"
              echo "always-auth=true"
            } >> .npmrc
          fi

      - name: Install dependencies
        run: npm ci

      - name: Configure Git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git config --global safe.directory ${{ github.workspace }}

      - name: Bump version + CHANGELOG + tag
        env:
          RELEASE_TYPE: ${{ env.RELEASE_TYPE }}
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          echo "Running CI release of type: $RELEASE_TYPE"

          if [ "$RELEASE_TYPE" = "patch" ]; then
            npm run release:patch:nopush -- -m "chore(release): v%s – CI release $BRANCH_NAME"
          elif [ "$RELEASE_TYPE" = "minor" ]; then
            npm run release:minor:nopush -- -m "chore(release): v%s – CI release $BRANCH_NAME"
          elif [ "$RELEASE_TYPE" = "major" ]; then
            npm run release:major:nopush -- -m "chore(release): v%s – CI release $BRANCH_NAME"
          else
            echo "Unknown RELEASE_TYPE: $RELEASE_TYPE"
            exit 1
          fi

          # Show latest tag & commit
          git describe --tags --abbrev=0 || true
          git log -1 --oneline

      - name: Push release commit & tags
        run: |
          set -euo pipefail
          echo "Pushing HEAD + tags to origin"
          git status
          git log -1 --oneline
          git push origin HEAD --follow-tags

      - name: Read version
        id: get_version
        env:
          PKG_PATH: ${{ env.PKG_PATH }}
        run: |
          VERSION=$(node -p "require('./' + process.env.PKG_PATH).version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Detected version: $VERSION"

  # ---------- Docker build & push (GHCR) ----------
  docker_build:
    runs-on: ubuntu-latest
    needs: [build_app, release]
    if: |
      always() &&
      needs.build_app.result == 'success' &&
      (needs.release.result == 'success' || needs.release.result == 'skipped') &&
      github.event_name != 'pull_request' &&
      contains(fromJson('["master","develop","staging","uat"]'), github.ref_name)

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: Pull latest changes (including release commit)
        run: |
          git pull origin ${{ github.ref_name }}
          echo "Current commit:"
          git log -1 --oneline
          echo "Current version:"
          cat package.json | grep '"version"'
          
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure npm for Azure Artifacts
        env:
          AZURE_ARTIFACTS_PAT: ${{ secrets.AZURE_ARTIFACT_PAT }}
        run: |
          if [ -n "$AZURE_ARTIFACTS_PAT" ]; then
            {
              echo ""
              echo "//pkgs.dev.azure.com/cadai/:_authToken=${AZURE_ARTIFACTS_PAT}"
              echo "always-auth=true"
            } >> .npmrc
          fi

      - name: Determine build environment & build Angular
        id: build_env
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          npm ci

          echo "Branch: $BRANCH_NAME"

          if [ "$BRANCH_NAME" = "master" ]; then
            BUILD_ENV="production"
            echo "Using PROD config"
            cp public/assets/config.prod.json public/assets/config.json
            NG_CONFIG="production"
          elif [ "$BRANCH_NAME" = "uat" ] || [ "$BRANCH_NAME" = "staging" ]; then
            BUILD_ENV="uat"
            echo "Using UAT config"
            cp public/assets/config.uat.json public/assets/config.json
            NG_CONFIG="uat"
          else
            BUILD_ENV="development"
            echo "Using DEV config"
            cp public/assets/config.dev.json public/assets/config.json
            NG_CONFIG="development"
          fi

          echo "Environment: $BUILD_ENV"
          echo "build_env=$BUILD_ENV" >> "$GITHUB_OUTPUT"

          echo "Building Angular with configuration: $NG_CONFIG"
          npm run build -- --configuration=$NG_CONFIG

          echo "Dist content:"
          ls -R dist || true

      - name: Read version
        id: version
        env:
          PKG_PATH: ${{ env.PKG_PATH }}
        run: |
          VERSION=$(node -p "require('./' + process.env.PKG_PATH).version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Detected version: $VERSION"

      - name: Compute image repo + safe branch
        id: image_meta
        run: |
          repo="${GITHUB_REPOSITORY,,}"
          safe_branch="${GITHUB_REF_NAME//\//-}"
          echo "repo=$repo" >> "$GITHUB_OUTPUT"
          echo "branch=$safe_branch" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.CR_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        env:
          VERSION: ${{ steps.version.outputs.version }}
        with:
          context: .
          file: ./Dockerfile
          push: true
          build-args: |
            ENVIRONMENT=${{ steps.build_env.outputs.build_env }}
          tags: |
            ${{ env.CR_REGISTRY }}/${{ steps.image_meta.outputs.repo }}:${{ steps.image_meta.outputs.branch }}-acd-${{ env.VERSION }}
            ${{ env.CR_REGISTRY }}/${{ steps.image_meta.outputs.repo }}:latest-acd-${{ steps.image_meta.outputs.branch }}