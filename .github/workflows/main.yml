name: Starter CI

on:
  push:
    branches: [ master, develop, staging, uat ]
  pull_request:
    branches: [ master, develop, staging, uat ]

permissions:
  contents: write
  packages: write

env:
  NODE_VERSION: '20'
  PKG_PATH: 'package.json'
  CR_REGISTRY: ghcr.io

jobs:
  # ---------- Build + Lint ----------
  build_app:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure npm for Azure Artifacts (using AZURE_ARTIFACT_PAT)
        env:
          AZURE_ARTIFACTS_PAT: ${{ secrets.AZURE_ARTIFACT_PAT }}
        run: |
          if [ -n "$AZURE_ARTIFACTS_PAT" ]; then
            echo "Configuring npm for Azure Artifacts into project .npmrc"
            {
              echo ""
              echo "//pkgs.dev.azure.com/cadai/:_authToken=${AZURE_ARTIFACTS_PAT}"
              echo "always-auth=true"
            } >> .npmrc

            echo "Final .npmrc:"
            cat .npmrc
          else
            echo "AZURE_ARTIFACT_PAT is empty, skipping Azure Artifacts config"
          fi

      - name: Install dependencies & lint
        run: |
          npm ci
          npm run lint

  # ---------- Docker build & push (GHCR) ----------
  docker_build:
    runs-on: ubuntu-latest
    needs: build_app
    if: contains(fromJson('["master","develop","staging","uat"]'), github.ref_name)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure npm for Azure Artifacts (using AZURE_ARTIFACT_PAT)
        env:
          AZURE_ARTIFACTS_PAT: ${{ secrets.AZURE_ARTIFACT_PAT }}
        run: |
          if [ -n "$AZURE_ARTIFACTS_PAT" ]; then
            echo "Configuring npm for Azure Artifacts into project .npmrc"
            {
              echo ""
              echo "//pkgs.dev.azure.com/cadai/:_authToken=${AZURE_ARTIFACTS_PAT}"
              echo "always-auth=true"
            } >> .npmrc
          else
            echo "AZURE_ARTIFACT_PAT is empty, skipping Azure Artifacts config"
          fi

      - name: Install deps & build Angular (with env config)
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          npm ci

          echo "Branch: $BRANCH_NAME"

          if [ "$BRANCH_NAME" = "master" ]; then
            echo "Using PROD config"
            cp public/assets/config.prod.json public/assets/config.json
            NG_CONFIG="production"
          elif [ "$BRANCH_NAME" = "uat" ]; then
            echo "Using UAT config"
            cp public/assets/config.uat.json public/assets/config.json
            NG_CONFIG="uat"
          elif [ "$BRANCH_NAME" = "staging" ]; then
            echo "Using UAT config"
            cp public/assets/config.uat.json public/assets/config.json
            NG_CONFIG="uat"
          else
            echo "Using DEV config"
            cp public/assets/config.dev.json public/assets/config.json
            NG_CONFIG="development"
          fi

          echo "Building Angular with configuration: $NG_CONFIG"
          npm run build -- --configuration=$NG_CONFIG

          echo "Dist content:"
          ls -R dist || true

      - name: Read version
        id: version
        env:
          PKG_PATH: ${{ env.PKG_PATH }}
        run: |
          VERSION=$(node -p "require('./' + process.env.PKG_PATH).version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Compute image repo + safe branch
        id: image_meta
        run: |
          # lowercase owner/repo
          repo="${GITHUB_REPOSITORY,,}"
          # replace '/' with '-' in branch name
          safe_branch="${GITHUB_REF_NAME//\//-}"
          echo "repo=$repo" >> "$GITHUB_OUTPUT"
          echo "branch=$safe_branch" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.CR_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        env:
          VERSION: ${{ steps.version.outputs.version }}
        with:
          context: .          # contains dist/psx-ng-skeleton we just built
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.CR_REGISTRY }}/${{ steps.image_meta.outputs.repo }}:${{ steps.image_meta.outputs.branch }}-${{ env.VERSION }}
            ${{ env.CR_REGISTRY }}/${{ steps.image_meta.outputs.repo }}:latest-${{ steps.image_meta.outputs.branch }}  