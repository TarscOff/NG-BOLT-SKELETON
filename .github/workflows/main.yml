name: Starter CI

on:
  push:
    branches: [ main, develop, staging, uat ]
  pull_request:
    branches: [ main, develop, staging, uat ]

permissions:
  contents: write
  packages: write

env:
  NODE_VERSION: '20'
  PKG_PATH: 'package.json'
  CR_REGISTRY: ghcr.io

jobs:
  # ---------- Build + Lint + Angular ----------
  build_app:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure npm for Azure Artifacts (using AZURE_ARTIFACT_PAT)
        env:
          AZURE_ARTIFACTS_PAT: ${{ secrets.AZURE_ARTIFACT_PAT }}
        run: |
          if [ -n "$AZURE_ARTIFACTS_PAT" ]; then
            echo "Configuring npm for Azure Artifacts into project .npmrc"
            {
              echo ""
              echo "//pkgs.dev.azure.com/cadai/:_authToken=${AZURE_ARTIFACTS_PAT}"
              echo "always-auth=true"
            } >> .npmrc

            echo "Final .npmrc:"
            cat .npmrc
          else
            echo "AZURE_ARTIFACT_PAT is empty, skipping Azure Artifacts config"
          fi

      - name: Install dependencies & lint
        run: |
          npm ci
          npm run lint

      - name: Select config and build Angular
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          echo "Branch: $BRANCH_NAME"

          if [ "$BRANCH_NAME" = "main" ]; then
            echo "Using PROD config"
            cp public/assets/config.prod.json public/assets/config.json
            NG_CONFIG="production"
          elif [ "$BRANCH_NAME" = "uat" ]; then
            echo "Using UAT config"
            cp public/assets/config.uat.json public/assets/config.json
            NG_CONFIG="uat"
          else
            echo "Using DEV config"
            cp public/assets/config.dev.json public/assets/config.json
            NG_CONFIG="development"
          fi

          echo "Building Angular with configuration: $NG_CONFIG"
          npm run build -- --configuration=$NG_CONFIG

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist

  # ---------- Docker build & push (GHCR) ----------
  docker_build:
    runs-on: ubuntu-latest
    needs: build_app
    if: contains(fromJson('["main","develop","staging","uat"]'), github.ref_name)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: .

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Read version
        id: version
        env:
          PKG_PATH: ${{ env.PKG_PATH }}
        run: |
          VERSION=$(node -p "require('./' + process.env.PKG_PATH).version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Compute image repo + safe branch
        id: image_meta
        run: |
          # lowercase owner/repo
          repo="${GITHUB_REPOSITORY,,}"
          # replace '/' with '-' in branch name
          safe_branch="${GITHUB_REF_NAME//\//-}"
          echo "repo=$repo" >> "$GITHUB_OUTPUT"
          echo "branch=$safe_branch" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.CR_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        env:
          VERSION: ${{ steps.version.outputs.version }}
        with:
          context: .          # includes dist/ from artifact
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.CR_REGISTRY }}/${{ steps.image_meta.outputs.repo }}:${{ steps.image_meta.outputs.branch }}-${{ env.VERSION }}
            ${{ env.CR_REGISTRY }}/${{ steps.image_meta.outputs.repo }}:latest-${{ steps.image_meta.outputs.branch }}

  # ---------- Auto release on develop (patch bump) ----------
  auto_release_develop:
    runs-on: ubuntu-latest
    needs: docker_build
    # Only on develop, and skip if this push is already a release commit
    if: github.ref == 'refs/heads/develop'
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure npm for Azure Artifacts (using AZURE_ARTIFACT_PAT)
        env:
          AZURE_ARTIFACTS_PAT: ${{ secrets.AZURE_ARTIFACT_PAT }}
        run: |
          if [ -n "$AZURE_ARTIFACTS_PAT" ]; then
            echo "Configuring npm for Azure Artifacts into project .npmrc"
            {
              echo ""
              echo "//pkgs.dev.azure.com/cadai/:_authToken=${AZURE_ARTIFACTS_PAT}"
              echo "always-auth=true"
            } >> .npmrc
          else
            echo "AZURE_ARTIFACT_PAT is empty, skipping Azure Artifacts config"
          fi

      - name: Install dependencies
        run: npm ci

      - name: Configure git identity
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Run patch release on develop
        run: |
          npm run release:patch -- -m "chore(release): v%s â€“ automated develop merge"

  # ---------- CSP smoke test ----------
  csp_test:
    runs-on: ubuntu-latest
    needs: docker_build
    if: contains(fromJson('["main","develop","staging","uat"]'), github.ref_name)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Read version
        id: version
        env:
          PKG_PATH: ${{ env.PKG_PATH }}
        run: |
          VERSION=$(node -p "require('./' + process.env.PKG_PATH).version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Compute image repo + safe branch
        id: image_meta
        run: |
          repo="${GITHUB_REPOSITORY,,}"
          safe_branch="${GITHUB_REF_NAME//\//-}"
          echo "repo=$repo" >> "$GITHUB_OUTPUT"
          echo "branch=$safe_branch" >> "$GITHUB_OUTPUT"

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Run CSP test
        env:
          VERSION: ${{ steps.version.outputs.version }}
          CR_REGISTRY: ${{ env.CR_REGISTRY }}
          IMAGE_REPO: ${{ steps.image_meta.outputs.repo }}
          BRANCH: ${{ steps.image_meta.outputs.branch }}
        run: |
          set -euo pipefail
          IMAGE_TAG="$BRANCH-$VERSION"
          IMAGE="$CR_REGISTRY/$IMAGE_REPO:$IMAGE_TAG"

          KC=$(jq -r '.auth.url' public/assets/config.json | sed 's:/*$::')
          API=$(jq -r '.apiUrl' public/assets/config.json)
          if [ "$BRANCH" = "main" ]; then REPORT=false; else REPORT=true; fi

          docker run -d --rm \
            -e KEYCLOAK_ORIGIN="$KC" \
            -e API_ORIGINS="$API" \
            -e CSP_REPORT_ONLY="$REPORT" \
            -p 8081:80 "$IMAGE"

          sleep 5
          curl -sI http://localhost:8081 | grep -i "content-security-policy"