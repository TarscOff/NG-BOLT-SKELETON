name: Starter CI

on:
  push:
    branches: [ main, develop, staging, uat ]
  pull_request:
    branches: [ main, develop, staging, uat ]

permissions:
  contents: write
  packages: write

env:
  NODE_VERSION: '20'
  PKG_PATH: 'package.json'
  CR_REGISTRY: ghcr.io

jobs:
  # ---------- Auto release on develop (patch bump) ----------
  auto_release_develop:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    # Decide once per job if we should run the release logic
    env:
      SHOULD_RELEASE: ${{ github.event_name == 'push'
        && github.ref == 'refs/heads/develop'
        && !startsWith(github.event.head_commit.message, 'chore(release):') }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show release decision
        run: |
          echo "SHOULD_RELEASE=${SHOULD_RELEASE}"

      - name: Setup Node
        if: env.SHOULD_RELEASE == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure npm for Azure Artifacts (using AZURE_ARTIFACT_PAT)
        if: env.SHOULD_RELEASE == 'true'
        env:
          AZURE_ARTIFACTS_PAT: ${{ secrets.AZURE_ARTIFACT_PAT }}
        run: |
          if [ -n "$AZURE_ARTIFACTS_PAT" ]; then
            echo "Configuring npm for Azure Artifacts into project .npmrc"
            {
              echo ""
              echo "//pkgs.dev.azure.com/cadai/:_authToken=${AZURE_ARTIFACTS_PAT}"
              echo "always-auth=true"
            } >> .npmrc
          else
            echo "AZURE_ARTIFACT_PAT is empty, skipping Azure Artifacts config"
          fi

      - name: Install dependencies
        if: env.SHOULD_RELEASE == 'true'
        run: npm ci

      - name: Configure git identity & remote
        if: env.SHOULD_RELEASE == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "Build Bot"
          git config user.email "build-bot@ci"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

      - name: Run patch release on develop (no push inside script)
        if: env.SHOULD_RELEASE == 'true'
        run: |
          npm run release:patch:nopush -- -m "chore(release): v%s â€“ bump version"

      - name: Push branch and tags
        if: env.SHOULD_RELEASE == 'true'
        run: |
          set -euo pipefail
          BRANCH_NAME="${GITHUB_REF_NAME}"   # 'develop'
          echo "Pushing branch ${BRANCH_NAME} and tags"
          git push origin "HEAD:${BRANCH_NAME}"
          git push origin --tags

  # ---------- Build + Lint ----------
  build_app:
    runs-on: ubuntu-latest
    needs: auto_release_develop

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ðŸ” Sync to latest remote HEAD (so we see the bumped package.json)
      - name: Sync to latest branch HEAD
        run: |
          set -euo pipefail
          BRANCH_NAME="${GITHUB_REF_NAME}"
          echo "Syncing to origin/${BRANCH_NAME}"
          git fetch origin "${BRANCH_NAME}"
          git checkout -B "${BRANCH_NAME}" "origin/${BRANCH_NAME}"
          echo "Current HEAD after sync:"
          git log -1 --oneline

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure npm for Azure Artifacts (using AZURE_ARTIFACT_PAT)
        env:
          AZURE_ARTIFACTS_PAT: ${{ secrets.AZURE_ARTIFACT_PAT }}
        run: |
          if [ -n "$AZURE_ARTIFACTS_PAT" ]; then
            echo "Configuring npm for Azure Artifacts into project .npmrc"
            {
              echo ""
              echo "//pkgs.dev.azure.com/cadai/:_authToken=${AZURE_ARTIFACTS_PAT}"
              echo "always-auth=true"
            } >> .npmrc

            echo "Final .npmrc:"
            cat .npmrc
          else
            echo "AZURE_ARTIFACT_PAT is empty, skipping Azure Artifacts config"
          fi

      - name: Install dependencies & lint
        run: |
          npm ci
          npm run lint

  # ---------- Docker build & push (GHCR) ----------
  docker_build:
    runs-on: ubuntu-latest
    needs: build_app
    if: contains(fromJson('["main","develop","staging","uat"]'), github.ref_name)

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ðŸ” Sync again (this job is a new clone, we want latest bumped HEAD)
      - name: Sync to latest branch HEAD
        run: |
          set -euo pipefail
          BRANCH_NAME="${GITHUB_REF_NAME}"
          echo "Syncing to origin/${BRANCH_NAME}"
          git fetch origin "${BRANCH_NAME}"
          git checkout -B "${BRANCH_NAME}" "origin/${BRANCH_NAME}"
          echo "Current HEAD after sync (docker_build):"
          git log -1 --oneline

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure npm for Azure Artifacts (using AZURE_ARTIFACT_PAT)
        env:
          AZURE_ARTIFACTS_PAT: ${{ secrets.AZURE_ARTIFACT_PAT }}
        run: |
          if [ -n "$AZURE_ARTIFACTS_PAT" ]; then
            echo "Configuring npm for Azure Artifacts into project .npmrc"
            {
              echo ""
              echo "//pkgs.dev.azure.com/cadai/:_authToken=${AZURE_ARTIFACTS_PAT}"
              echo "always-auth=true"
            } >> .npmrc
          else
            echo "AZURE_ARTIFACT_PAT is empty, skipping Azure Artifacts config"
          fi

      - name: Install deps & build Angular (with env config)
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          npm ci

          echo "Branch: $BRANCH_NAME"

          if [ "$BRANCH_NAME" = "main" ]; then
            echo "Using PROD config"
            cp public/assets/config.prod.json public/assets/config.json
            NG_CONFIG="production"
          elif [ "$BRANCH_NAME" = "uat" ]; then
            echo "Using UAT config"
            cp public/assets/config.uat.json public/assets/config.json
            NG_CONFIG="uat"
          else
            echo "Using DEV config"
            cp public/assets/config.dev.json public/assets/config.json
            NG_CONFIG="development"
          fi

          echo "Building Angular with configuration: $NG_CONFIG"
          npm run build -- --configuration=$NG_CONFIG

          echo "Dist content:"
          ls -R dist || true

      - name: Read version
        id: version
        env:
          PKG_PATH: ${{ env.PKG_PATH }}
        run: |
          VERSION=$(node -p "require('./' + process.env.PKG_PATH).version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Compute image repo + safe branch
        id: image_meta
        run: |
          # lowercase owner/repo
          repo="${GITHUB_REPOSITORY,,}"
          # replace '/' with '-' in branch name
          safe_branch="${GITHUB_REF_NAME//\//-}"
          echo "repo=$repo" >> "$GITHUB_OUTPUT"
          echo "branch=$safe_branch" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.CR_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        env:
          VERSION: ${{ steps.version.outputs.version }}
        with:
          context: .          # contains dist/psx-ng-skeleton we just built
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.CR_REGISTRY }}/${{ steps.image_meta.outputs.repo }}:${{ steps.image_meta.outputs.branch }}-${{ env.VERSION }}
            ${{ env.CR_REGISTRY }}/${{ steps.image_meta.outputs.repo }}:latest-${{ steps.image_meta.outputs.branch }}

  # ---------- CSP smoke test ----------
  csp_test:
    runs-on: ubuntu-latest
    needs: docker_build
    if: contains(fromJson('["main","develop","staging","uat"]'), github.ref_name)

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ðŸ” Same sync here to be consistent
      - name: Sync to latest branch HEAD
        run: |
          set -euo pipefail
          BRANCH_NAME="${GITHUB_REF_NAME}"
          echo "Syncing to origin/${BRANCH_NAME}"
          git fetch origin "${BRANCH_NAME}"
          git checkout -B "${BRANCH_NAME}" "origin/${BRANCH_NAME}"
          echo "Current HEAD after sync (csp_test):"
          git log -1 --oneline

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure npm for Azure Artifacts (using AZURE_ARTIFACT_PAT)
        env:
          AZURE_ARTIFACTS_PAT: ${{ secrets.AZURE_ARTIFACT_PAT }}
        run: |
          if [ -n "$AZURE_ARTIFACTS_PAT" ]; then
            {
              echo ""
              echo "//pkgs.dev.azure.com/cadai/:_authToken=${AZURE_ARTIFACTS_PAT}"
              echo "always-auth=true"
            } >> .npmrc
          fi

      # Ensure config.json matches branch (for KC/API urls)
      - name: Select config for CSP test
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          echo "Branch for CSP test: $BRANCH_NAME"

          if [ "$BRANCH_NAME" = "main" ]; then
            echo "Using PROD config"
            cp public/assets/config.prod.json public/assets/config.json
          elif [ "$BRANCH_NAME" = "uat" ]; then
            echo "Using UAT config"
            cp public/assets/config.uat.json public/assets/config.json
          else
            echo "Using DEV config"
            cp public/assets/config.dev.json public/assets/config.json
          fi

      - name: Read version
        id: version
        env:
          PKG_PATH: ${{ env.PKG_PATH }}
        run: |
          VERSION=$(node -p "require('./' + process.env.PKG_PATH).version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Compute image repo + safe branch
        id: image_meta
        run: |
          repo="${GITHUB_REPOSITORY,,}"
          safe_branch="${GITHUB_REF_NAME//\//-}"
          echo "repo=$repo" >> "$GITHUB_OUTPUT"
          echo "branch=$safe_branch" >> "$GITHUB_OUTPUT"

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Run CSP test
        env:
          VERSION: ${{ steps.version.outputs.version }}
          CR_REGISTRY: ${{ env.CR_REGISTRY }}
          IMAGE_REPO: ${{ steps.image_meta.outputs.repo }}
          BRANCH: ${{ steps.image_meta.outputs.branch }}
        run: |
          set -euo pipefail
          IMAGE_TAG="$BRANCH-$VERSION"
          IMAGE="$CR_REGISTRY/$IMAGE_REPO:$IMAGE_TAG"

          KC=$(jq -r '.auth.url' public/assets/config.json | sed 's:/*$::')
          API=$(jq -r '.apiUrl' public/assets/config.json)
          if [ "$BRANCH" = "main" ]; then REPORT=false; else REPORT=true; fi

          docker run -d --rm \
            -e KEYCLOAK_ORIGIN="$KC" \
            -e API_ORIGINS="$API" \
            -e CSP_REPORT_ONLY="$REPORT" \
            -p 8081:80 "$IMAGE"

          sleep 5
          curl -sI http://localhost:8081 | grep -i "content-security-policy"
