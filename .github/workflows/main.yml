name: Starter CI

on:
  push:
    branches: [ main, develop, staging, uat ]
  pull_request:
    branches: [ main, develop, staging, uat ]

permissions:
  contents: write
  packages: write

env:
  NODE_VERSION: '20'
  PKG_PATH: 'package.json'
  CR_REGISTRY: ghcr.io
  # e.g. ghcr.io/owner/repo
  CR_REPOSITORY: ${{ github.repository }}

jobs:
  # ---------- Build + Lint + Angular ----------
  build_app:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure npm for Azure Artifacts
        if: ${{ secrets.BOLT_SECRET != '' }}
        env:
          AZURE_ARTIFACTS_PAT: ${{ secrets.BOLT_SECRET }}
        run: |
          echo "//pkgs.dev.azure.com/cadai/:_authToken=${AZURE_ARTIFACTS_PAT}" > ~/.npmrc
          echo "always-auth=true" >> ~/.npmrc

      - name: Install dependencies & lint
        run: |
          npm ci
          npm run lint

      - name: Select config and build Angular
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          echo "Branch: $BRANCH_NAME"

          if [ "$BRANCH_NAME" = "main" ]; then
            echo "Using PROD config"
            cp public/assets/config.prod.json public/assets/config.json
            NG_CONFIG="production"
          elif [ "$BRANCH_NAME" = "uat" ]; then
            echo "Using UAT config"
            cp public/assets/config.uat.json public/assets/config.json
            NG_CONFIG="uat"
          else
            echo "Using DEV config"
            cp public/assets/config.dev.json public/assets/config.json
            NG_CONFIG="development"
          fi

          echo "Building Angular with configuration: $NG_CONFIG"
          npm run build -- --configuration=$NG_CONFIG

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/psx-ng-skeleton

  # ---------- Docker build & push ----------
  docker_build:
    runs-on: ubuntu-latest
    needs: build_app

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Read version
        id: version
        env:
          PKG_PATH: ${{ env.PKG_PATH }}
        run: |
          VERSION=$(node -p "require('./' + process.env.PKG_PATH).version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.CR_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        env:
          VERSION: ${{ steps.version.outputs.version }}
          BRANCH_NAME: ${{ github.ref_name }}
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.CR_REGISTRY }}/${{ env.CR_REPOSITORY }}:${{ env.BRANCH_NAME }}-${{ env.VERSION }}
            ${{ env.CR_REGISTRY }}/${{ env.CR_REPOSITORY }}:latest-${{ env.BRANCH_NAME }}

  # ---------- CSP smoke test ----------
  csp_test:
    runs-on: ubuntu-latest
    needs: docker_build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Read version
        id: version
        env:
          PKG_PATH: ${{ env.PKG_PATH }}
        run: |
          VERSION=$(node -p "require('./' + process.env.PKG_PATH).version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Run CSP test
        env:
          VERSION: ${{ steps.version.outputs.version }}
          BRANCH_NAME: ${{ github.ref_name }}
          CR_REGISTRY: ${{ env.CR_REGISTRY }}
          CR_REPOSITORY: ${{ env.CR_REPOSITORY }}
        run: |
          set -euo pipefail
          IMAGE_TAG="$BRANCH_NAME-$VERSION"
          IMAGE="$CR_REGISTRY/$CR_REPOSITORY:$IMAGE_TAG"

          KC=$(jq -r '.auth.url' public/assets/config.json | sed 's:/*$::')
          API=$(jq -r '.apiUrl' public/assets/config.json)
          if [ "$BRANCH_NAME" = "main" ]; then REPORT=false; else REPORT=true; fi

          docker run -d --rm \
            -e KEYCLOAK_ORIGIN="$KC" \
            -e API_ORIGINS="$API" \
            -e CSP_REPORT_ONLY="$REPORT" \
            -p 8081:80 "$IMAGE"

          sleep 5
          curl -sI http://localhost:8081 | grep -i "content-security-policy"

  # ---------- Tag on main ----------
  tag_release:
    runs-on: ubuntu-latest
    needs: docker_build
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Read version
        id: version
        env:
          PKG_PATH: ${{ env.PKG_PATH }}
        run: |
          VERSION=$(node -p "require('./' + process.env.PKG_PATH).version")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Create and push tag
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          set -euo pipefail
          TAG="PXS-NG-STARTER-APP@$VERSION"
          echo "Detected version: $VERSION"
          echo "Proposed tag:    $TAG"

          git fetch --tags
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists. Nothing to do."
            exit 0
          fi

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git tag -a "$TAG" -m "release: $TAG"
          git push origin "$TAG"
