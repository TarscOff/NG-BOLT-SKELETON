<div class="compare-container">
  <app-export-overlay-tpl />
  
  <!-- Header -->
  <div class="compare-header">
    <div class="compare-header-info">
      <mat-icon [color]="(isDark$ | async) ? 'accent' : 'primary'">compare</mat-icon>
      <span class="compare-title">{{ 'compareTpl.title' | translate }}</span>
    </div>
    <div class="compare-header-actions">
      @if (isPreloadedMode$() && result$()) {
        <div class="result-actions">
          <!-- Export Actions -->
          <button mat-icon-button 
            [color]="(isDark$ | async) ? 'neutral' : 'primary'" 
            (click)="exportComparison({ format: 'pdf', result: result$()! })"
            [disabled]="(exportService.isExporting$ | async)" 
            [matTooltip]="'summarizeTpl.exportPdf' | translate">
            <mat-icon>picture_as_pdf</mat-icon>
          </button>
          <button mat-icon-button 
            [color]="(isDark$ | async) ? 'neutral' : 'primary'" 
            (click)="exportComparison({ format: 'docx', result: result$()! })"
            [disabled]="(exportService.isExporting$ | async)" 
            [matTooltip]="'summarizeTpl.exportDocx' | translate">
            <mat-icon>description</mat-icon>
          </button>
          <button mat-icon-button 
            [color]="(isDark$ | async) ? 'neutral' : 'primary'" 
            (click)="exportComparison({ format: 'txt', result: result$()! })"
            [disabled]="(exportService.isExporting$ | async)" 
            [matTooltip]="'summarizeTpl.exportTxt' | translate">
            <mat-icon>notes</mat-icon>
          </button>
        </div>
      }
      @if (!isPreloadedMode$()) {
        <button mat-icon-button 
          [matTooltip]="'compareTpl.clear' | translate" 
          (click)="clearAll()"
          [disabled]="!canClearAll$()" 
          [color]="(isDark$ | async) ? 'accent' : 'accent'">
          <mat-icon>clear_all</mat-icon>
        </button>
      }
    </div>
  </div>

  <div class="compare-container__body" #comparisonResultContainer>
    
    @if (isPreloadedMode$()) {
      <!-- PRELOADED MODE: Show loaded files -->
      <div class="preloaded-files-section">
        <div class="preloaded-files-header">
          <mat-icon color="primary">folder_open</mat-icon>
          <span>{{ 'compareTpl.loadedFiles' | translate }}</span>
        </div>

        <div class="preloaded-files-grid">
          <!-- File 1 -->
          @if (file1$()) {
            <div class="file-card">
              <div class="file-card-header">
                <mat-icon [color]="(isDark$ | async) ? 'accent' : 'primary'">
                  {{ getFileIcon(file1$()!) }}
                </mat-icon>
                <span class="file-badge">{{ 'compareTpl.file1' | translate }}</span>
              </div>
              <div class="file-card-body">
                <div class="file-name" [matTooltip]="file1$()!.name">
                  {{ file1$()!.name }}
                </div>
                <div class="file-details">
                  <span class="file-size">{{ formatFileSize(file1$()!.size) }}</span>
                  @if (file1$()!.uploadDate) {
                    <span class="file-date">{{ file1$()!.uploadDate | date: 'short' }}</span>
                  }
                </div>
              </div>
            </div>
          }

          <!-- VS Divider -->
          <div class="files-divider">
            <mat-icon [color]="(isDark$ | async) ? 'neutral' : 'primary'">compare_arrows</mat-icon>
          </div>

          <!-- File 2 -->
          @if (file2$()) {
            <div class="file-card">
              <div class="file-card-header">
                <mat-icon [color]="(isDark$ | async) ? 'success' : 'accent'">
                  {{ getFileIcon(file2$()!) }}
                </mat-icon>
                <span class="file-badge accent">{{ 'compareTpl.file2' | translate }}</span>
              </div>
              <div class="file-card-body">
                <div class="file-name" [matTooltip]="file2$()!.name">
                  {{ file2$()!.name }}
                </div>
                <div class="file-details">
                  <span class="file-size">{{ formatFileSize(file2$()!.size) }}</span>
                  @if (file2$()!.uploadDate) {
                    <span class="file-date">{{ file2$()!.uploadDate | date: 'short' }}</span>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    } @else {
      <!-- UPLOAD MODE: Show upload forms -->
      <div class="compare-upload-section">
        <!-- File 1 -->
        <div class="upload-column">
          <div class="upload-header">
            <span class="upload-label">{{ 'compareTpl.file1' | translate }}</span>
            @if (file1$()) {
              <button mat-icon-button 
                [matTooltip]="'compareTpl.clearFile' | translate" 
                (click)="clearFile(1)"
                [disabled]="!canClearFile1$()" 
                class="clear-file-btn">
                <mat-icon>close</mat-icon>
              </button>
            }
          </div>
          <app-dynamic-form [form]="formFile1" [config]="configFile1" />
        </div>

        <!-- Divider -->
        <div class="upload-divider">
          <mat-icon [color]="(isDark$ | async) ? 'neutral' : 'primary'">compare_arrows</mat-icon>
        </div>

        <!-- File 2 -->
        <div class="upload-column">
          <div class="upload-header">
            <span class="upload-label">{{ 'compareTpl.file2' | translate }}</span>
            @if (file2$()) {
              <button mat-icon-button 
                [matTooltip]="'compareTpl.clearFile' | translate" 
                (click)="clearFile(2)"
                [disabled]="!canClearFile2$()" 
                class="clear-file-btn">
                <mat-icon>close</mat-icon>
              </button>
            }
          </div>
          <app-dynamic-form [form]="formFile2" [config]="configFile2" />
        </div>
      </div>
    }

    <!-- Progress Section -->
    @if ((isUploading$() || isComparing$())) {
      <div class="compare-progress-section">
        @if (isUploading$()) {
          <div class="progress-info">
            <span class="progress-label">{{ 'compareTpl.uploading' | translate }}</span>
            <span class="progress-value">{{ uploadProgress$() }}%</span>
          </div>
          <mat-progress-bar mode="determinate" [value]="uploadProgress$()" color="primary" />
        }

        @if (isComparing$()) {
          <div class="progress-info">
            <span class="progress-label">{{ 'compareTpl.comparing' | translate }}</span>
            <span class="progress-value">{{ comparisonProgress$() }}%</span>
          </div>
          <mat-progress-bar mode="determinate" [value]="comparisonProgress$()" color="accent" />
        }
      </div>
    }

    <!-- Compare Action (Upload Mode Only) -->
    @if (!isPreloadedMode$() && !result$()) {
      <div class="compare-action">
        <button mat-flat-button 
          class="primary" 
          [disabled]="!canCompare$()"
          (click)="triggerComparison()">
          @if (isComparing$()) {
            <mat-icon class="spinner-icon">
              <span class="material-icons rotating">sync</span>
            </mat-icon>
          } @else {
            <mat-icon>compare</mat-icon>
          }
          <span>{{ 'compareTpl.start' | translate }}</span>
        </button>
      </div>
    }

    <!-- Results Section -->
    @if (result$()) {
      <div class="compare-results-section">
        <app-comparison-result-tpl [result]="result$()!" />
      </div>
    }
  </div>
</div>