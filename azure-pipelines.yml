trigger:
  branches:
    include:
      - main
      - dev
      - uat

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: Build
    jobs:
      - job: BuildJob
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'

          - script: |
              npm ci
              npm run lint
            displayName: 'Install & Lint App'

          - script: |
              if [[ "$(Build.SourceBranchName)" == "main" ]]; then
                cp public/assets/config.prod.json public/assets/config.json
              elif [[ "$(Build.SourceBranchName)" == "uat" ]]; then
                cp public/assets/config.uat.json public/assets/config.json
              else
                cp public/assets/config.dev.json public/assets/config.json
              fi
              npm run build -- --configuration=production
            displayName: 'Build Angular App'

          - script: |
              VERSION=$(node -p "require('./package.json').version")
              docker build -t myapp:$(Build.SourceBranchName)-$VERSION .
            displayName: 'Build Docker Image with version tag'