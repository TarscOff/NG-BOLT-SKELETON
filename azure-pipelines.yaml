trigger:
  branches:
    include:
      - main
      - develop
      - staging
      - uat

pr:
  branches:
    include:
      - main
      - develop
      - staging
      - uat

pool:
  vmImage: 'ubuntu-latest'

variables:
  NODE_VERSION: '20.x'
  DOCKER_REPOSITORY: 'pxs-ng-starter-app'
  DOCKER_SERVICE_CONNECTION: 'FrontSocleServiceConn'
  PKG_PATH: 'package.json'
  APP_NAME: 'pxs-ng-starter-app'

stages:


# ---------- Auto patch release on develop ----------
- stage: auto_release_develop
  displayName: 'Auto patch release on develop'
  condition: and(
      succeeded(),
      eq(variables['Build.SourceBranch'], 'refs/heads/develop'),
      ne(variables['Build.Reason'], 'PullRequest')
    )
  jobs:
    - job: release_job
      displayName: 'Run npm patch release on develop'
      steps:
        - checkout: self
          persistCredentials: true

        - task: NodeTool@0
          inputs:
            versionSpec: '$(NODE_VERSION)'
          displayName: 'Use Node.js'

        # (re)authenticate for npm in case release script ever needs deps
        - task: npmAuthenticate@0
          displayName: 'Authenticate to Azure Artifacts (npm) for release'
          inputs:
            workingFile: '.npmrc'

        - script: |
            set -euo pipefail

            # Auth for pushing back to Azure Repos
            git config --global http.https://dev.azure.com/.extraheader "AUTHORIZATION: bearer $(System.AccessToken)"
            git config user.email "build-bot@ci"
            git config user.name  "Build Bot"
            git config --global safe.directory $(Build.SourcesDirectory)

            # standard-version / release scripts need deps
            npm ci

            echo "Running npm run release:patch:nopush on develop"
            npm run release:patch:nopush -- -m "chore(release): v%s â€“ automated develop merge"

            # Push branch + tags manually
            BRANCH_REF="$BUILD_SOURCEBRANCH"          # e.g. refs/heads/develop
            BRANCH_NAME="${BRANCH_REF#refs/heads/}"   # develop

            echo "Pushing branch $BRANCH_NAME and tags"
            git push origin "HEAD:$BRANCH_NAME"
            git push origin --tags
          displayName: 'Run auto patch release and push'
          env:
            SYSTEM_ACCESSTOKEN: $(System.AccessToken)

# ---------- Build & Test & Docker ----------
   
- stage: build_test_docker
  displayName: 'Build, Test & Dockerize Starter App'
  dependsOn:
    - auto_release_develop
  jobs:
  - job: build
    displayName: 'Build Angular & Docker'
    steps:
      # 1) Authenticate to Azure Artifacts npm feed based on repo .npmrc
      - task: npmAuthenticate@0
        displayName: 'Authenticate to Azure Artifacts (npm)'
        inputs:
          workingFile: '.npmrc' # your project .npmrc at repo root

      # 2) Use Node
      - task: NodeTool@0
        displayName: 'Use Node.js $(NODE_VERSION)'
        inputs:
          versionSpec: '$(NODE_VERSION)'

      # 3) Install dependencies + lint
      - script: |
          set -euo pipefail
          npm ci
          npm run lint
        displayName: 'Install & Lint App'

      # 4) Select config file based on branch and build Angular
      - script: |
          set -euo pipefail

          BRANCH_NAME="$(Build.SourceBranchName)"
          echo "Branch: $BRANCH_NAME"

          if [ "$BRANCH_NAME" = "main" ]; then
            echo "Using PROD config"
            cp public/assets/config.prod.json public/assets/config.json
            NG_CONFIG="production"
          elif [ "$BRANCH_NAME" = "uat" ]; then
            echo "Using UAT config"
            cp public/assets/config.uat.json public/assets/config.json
            NG_CONFIG="uat"
          else
            echo "Using DEV config"
            cp public/assets/config.dev.json public/assets/config.json
            NG_CONFIG="development"
          fi

          echo "Running Angular build with configuration: $NG_CONFIG"
          npm run build -- --configuration=$NG_CONFIG
        displayName: 'Build Angular App with environment config'

      # 5) Extract version from package.json and expose as pipeline variable
      - script: |
          set -euo pipefail

          VERSION=$(node -p "require('./' + process.env.PKG_PATH).version")
          echo "Detected version from $PKG_PATH: $VERSION"
          echo "##vso[task.setvariable variable=APP_VERSION]$VERSION"
        displayName: 'Read version from package.json'
        env:
          PKG_PATH: $(PKG_PATH)
        name: SetVersion

      # 6) Build & push Docker image to registry
      - task: Docker@2
        displayName: 'Build & Push Docker image'
        condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
        inputs:
          containerRegistry: '$(DOCKER_SERVICE_CONNECTION)'
          repository: '$(DOCKER_REPOSITORY)'
          command: 'buildAndPush'
          dockerfile: 'Dockerfile'     # adjust path if needed
          tags: |
            $(Build.SourceBranchName)-$(APP_VERSION)
            latest-$(Build.SourceBranchName)
