trigger:
  branches:
    include:
      - main
      - develop
      - staging
      - uat

pr:
  branches:
    include:
      - main
      - develop
      - staging
      - uat

pool:
  vmImage: 'ubuntu-latest'

variables:
  NODE_VERSION: '20.x'
  # Name of the Docker repository inside your registry (e.g. pxs-ng-starter-app)
  DOCKER_REPOSITORY: 'pxs-ng-starter-app'
  # Name of the Docker registry service connection in Azure DevOps
  DOCKER_SERVICE_CONNECTION: 'FrontSocleServiceConn'
  # Path to package.json of the starter app (if not at root)
  PKG_PATH: 'package.json'

stages:
# ---------- Build & Test & Docker ----------

- stage: build_test_docker
  displayName: 'Build, Test & Dockerize Starter App'
  jobs:
  - job: build
    displayName: 'Build Angular & Docker'
    steps:
      # 1) Authenticate to Azure Artifacts npm feed based on repo .npmrc
      - task: npmAuthenticate@0
        displayName: 'Authenticate to Azure Artifacts (npm)'
        inputs:
          workingFile: '.npmrc' # your project .npmrc at repo root

      # 2) Use Node
      - task: NodeTool@0
        displayName: 'Use Node.js $(NODE_VERSION)'
        inputs:
          versionSpec: '$(NODE_VERSION)'

      # 3) Install dependencies + lint
      - script: |
          set -euo pipefail
          npm ci
          npm run lint
        displayName: 'Install & Lint App'

      # 4) Select config file based on branch and build Angular
      - script: |
          set -euo pipefail

          BRANCH_NAME="$(Build.SourceBranchName)"
          echo "Branch: $BRANCH_NAME"

          if [ "$BRANCH_NAME" = "main" ]; then
            echo "Using PROD config"
            cp public/assets/config.prod.json public/assets/config.json
            NG_CONFIG="production"
          elif [ "$BRANCH_NAME" = "uat" ]; then
            echo "Using UAT config"
            cp public/assets/config.uat.json public/assets/config.json
            NG_CONFIG="uat"
          else
            echo "Using DEV config"
            cp public/assets/config.dev.json public/assets/config.json
            NG_CONFIG="development"
          fi

          echo "Running Angular build with configuration: $NG_CONFIG"
          npm run build -- --configuration=$NG_CONFIG
        displayName: 'Build Angular App with environment config'

      # 5) Extract version from package.json and expose as pipeline variable
      - script: |
          set -euo pipefail

          VERSION=$(node -p "require('./' + process.env.PKG_PATH).version")
          echo "Detected version from $PKG_PATH: $VERSION"
          echo "##vso[task.setvariable variable=APP_VERSION]$VERSION"
        displayName: 'Read version from package.json'
        env:
          PKG_PATH: $(PKG_PATH)
        name: SetVersion

      # 6) Build & push Docker image to registry
      - task: Docker@2
        displayName: 'Build & Push Docker image'
        condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
        inputs:
          containerRegistry: '$(DOCKER_SERVICE_CONNECTION)'
          repository: '$(DOCKER_REPOSITORY)'
          command: 'buildAndPush'
          dockerfile: 'Dockerfile'     # adjust path if needed
          tags: |
            $(Build.SourceBranchName)-$(APP_VERSION)
            latest-$(Build.SourceBranchName)

- stage: tag_on_main
  displayName: "Create git tag for Starter from package version"
  dependsOn:
    - build_test_docker
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
    - job: tag_job
      displayName: "Tag repo with PXS-NG-STARTER-APP@<version>"
      steps:
        - checkout: self
          persistCredentials: true

        - task: NodeTool@0
          inputs:
            versionSpec: '$(NODE_VERSION)'
          displayName: 'Use Node.js'

        - script: |
            set -euo pipefail

            git config --global http.https://dev.azure.com/.extraheader "AUTHORIZATION: bearer $(System.AccessToken)"
            git config --global user.email "build-bot@ci"
            git config --global user.name  "Build Bot"
            git config --global safe.directory $(Build.SourcesDirectory)

            PKG_PATH="$(PKG_PATH)"
            VERSION=$(node -p "require('./$PKG_PATH').version")
            TAG="PXS-NG-STARTER-APP@$VERSION"

            echo "Detected version: $VERSION"
            echo "Proposed tag:    $TAG"

            git fetch --tags --force

            if git rev-parse "$TAG" >/dev/null 2>&1; then
              echo "Tag $TAG already exists. Nothing to do."
              exit 0
            fi

            git tag -a "$TAG" -m "release: $TAG"
            git push origin "$TAG"
            echo "Created and pushed tag $TAG"
          displayName: 'Create & push tag from package version'
          env:
            PKG_PATH: $(PKG_PATH)
            SYSTEM_ACCESSTOKEN: $(System.AccessToken)