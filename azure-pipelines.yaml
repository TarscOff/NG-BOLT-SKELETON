trigger:
  branches:
    include:
      - master
      - develop
      - staging
      - uat

pr:
  branches:
    include:
      - master
      - develop
      - staging
      - uat

pool:
  vmImage: 'ubuntu-latest'

variables:
  NODE_VERSION: '20.x'
  DOCKER_REPOSITORY: 'pxs-ng-starter-app'
  DOCKER_SERVICE_CONNECTION: 'FrontSocleServiceConn'
  PKG_PATH: 'package.json'
  APP_NAME: 'pxs-ng-starter-app'
  # default release type; can be overridden when running pipeline manually
  RELEASE_TYPE: 'patch'

stages:

# ---------- Build, Test, Docker, Release ----------
- stage: build_test_docker
  displayName: 'Build, Test, Dockerize & Release Starter App'
  jobs:
  - job: build
    displayName: 'Build Angular, Docker & (optionally) Release'
    steps:
      - checkout: self
        persistCredentials: true
        clean: true
        fetchDepth: 0  
        fetchTags: true 

      # 1) Authenticate to Azure Artifacts npm feed based on repo .npmrc
      - task: npmAuthenticate@0
        displayName: 'Authenticate to Azure Artifacts (npm)'
        condition: |
          and(
            succeeded(),
            not(startsWith(variables['Build.SourceVersionMessage'], 'chore(release):'))
          )
        inputs:
          workingFile: '.npmrc'

      # 2) Use Node
      - task: NodeTool@0
        displayName: 'Use Node.js $(NODE_VERSION)'
        condition: |
          and(
            succeeded(),
            not(startsWith(variables['Build.SourceVersionMessage'], 'chore(release):'))
          )
        inputs:
          versionSpec: '$(NODE_VERSION)'

      # 3) Install dependencies + lint
      - script: |
          set -euo pipefail
          npm ci
          npm run lint
        condition: |
          and(
            succeeded(),
            not(startsWith(variables['Build.SourceVersionMessage'], 'chore(release):'))
          )
        displayName: 'Install & Lint App'

      # 3.5) Configure Git identity for release commits
      - script: |
          set -euo pipefail
          git config --global user.email "build-bot@azure-pipelines.com"
          git config --global user.name "Azure Pipeline Bot"
          git config --global safe.directory $(Build.SourcesDirectory)
        condition: |
          and(
            succeeded(),
            not(startsWith(variables['Build.SourceVersionMessage'], 'chore(release):'))
          )
        displayName: 'Configure Git identity'

      # 4) CI release step (bump version + CHANGELOG.md + tag + JSON via release.js)
      #    Only on master, not PR, and not already a release commit
      - script: |
          set -euo pipefail

          echo "Running CI release of type: $(RELEASE_TYPE)"

          if [ "$(RELEASE_TYPE)" = "patch" ]; then
            npm run release:patch:nopush -- -m "chore(release): v%s – CI release $(Build.SourceBranchName)"
          elif [ "$(RELEASE_TYPE)" = "minor" ]; then
            npm run release:minor:nopush -- -m "chore(release): v%s – CI release $(Build.SourceBranchName)"
          elif [ "$(RELEASE_TYPE)" = "major" ]; then
            npm run release:major:nopush -- -m "chore(release): v%s – CI release $(Build.SourceBranchName)"
          else
            echo "Unknown RELEASE_TYPE: $(RELEASE_TYPE)"
            exit 1
          fi

          # Show latest tag & commit
          git describe --tags --abbrev=0 || true
          git log -1 --oneline
        displayName: 'Bump version + CHANGELOG + tag (standard-version via release.js)'
        condition: |
          and(
            succeeded(),
            eq(variables['Build.SourceBranch'], 'refs/heads/develop'),
            ne(variables['Build.Reason'], 'PullRequest'),
            not(startsWith(variables['Build.SourceVersionMessage'], 'chore(release):'))
          )
      # 5) Select config file based on branch and build Angular
      - script: |
          set -euo pipefail

          BRANCH_NAME="$(Build.SourceBranchName)"
          echo "Branch: $BRANCH_NAME"

          if [ "$BRANCH_NAME" = "master" ]; then
            echo "Using PROD config"
            cp public/assets/config.prod.json public/assets/config.json
            NG_CONFIG="production"
          elif [ "$BRANCH_NAME" = "uat" ]; then
            echo "Using UAT config"
            cp public/assets/config.uat.json public/assets/config.json
            NG_CONFIG="uat"
          elif [ "$BRANCH_NAME" = "staging" ]; then
            echo "Using UAT config"
            cp public/assets/config.uat.json public/assets/config.json
            NG_CONFIG="uat"
          else
            echo "Using DEV config"
            cp public/assets/config.dev.json public/assets/config.json
            NG_CONFIG="development"
          fi

          echo "Running Angular build with configuration: $NG_CONFIG"
          npm run build -- --configuration=$NG_CONFIG
        condition: |
          and(
            succeeded(),
            not(startsWith(variables['Build.SourceVersionMessage'], 'chore(release):'))
          )
        displayName: 'Build Angular App with environment config'

      # 6) Extract version from (possibly bumped) package.json and expose as pipeline variable
      - script: |
          set -euo pipefail

          VERSION=$(node -p "require('./' + process.env.PKG_PATH).version")
          echo "Detected version from $PKG_PATH: $VERSION"
          echo "##vso[task.setvariable variable=APP_VERSION]$VERSION"
        displayName: 'Read version from package.json'
        condition: |
          and(
            succeeded(),
            not(startsWith(variables['Build.SourceVersionMessage'], 'chore(release):'))
          )
        env:
          PKG_PATH: $(PKG_PATH)
        name: SetVersion

      # 7) Build & push Docker image to registry (skip on PRs)
      - task: Docker@2
        displayName: 'Build & Push Docker image'
        condition: and(
            succeeded(),
            ne(variables['Build.Reason'], 'PullRequest'),
            not(startsWith(variables['Build.SourceVersionMessage'], 'chore(release):'))
          )
        inputs:
          containerRegistry: '$(DOCKER_SERVICE_CONNECTION)'
          repository: '$(DOCKER_REPOSITORY)'
          command: 'buildAndPush'
          dockerfile: 'Dockerfile'
          tags: |
            $(Build.SourceBranchName)-acd-$(APP_VERSION)
            latest-acd-$(Build.SourceBranchName)

       # 8) Push release commit + tags (only when we actually did a release)
      - script: |
          set -euo pipefail

          # Reset any modified files that shouldn't be committed (config.json, .npmrc)
          git checkout -- .npmrc public/assets/config.json || true

          # Use the System.AccessToken for git HTTPS ops
          git config --global http.https://dev.azure.com/.extraheader "AUTHORIZATION: bearer $(System.AccessToken)"

          echo "Current git status:"
          git status
          git log -1 --oneline

          echo "Pushing HEAD + tags to origin/$(Build.SourceBranchName)"
          git push origin HEAD:refs/heads/$(Build.SourceBranchName) --follow-tags
        displayName: 'Push release commit & tags'
        condition: |
          and(
            succeeded(),
            eq(variables['Build.SourceBranch'], 'refs/heads/develop'),
            ne(variables['Build.Reason'], 'PullRequest'),
            not(startsWith(variables['Build.SourceVersionMessage'], 'chore(release):'))
          )
        env:
          SYSTEM_ACCESSTOKEN: $(System.AccessToken)
